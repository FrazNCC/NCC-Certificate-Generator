<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Certificate Generator - Professional</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: white;
            padding: 40px 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
            letter-spacing: 1px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
        }

        .nav-tab {
            flex: 1;
            padding: 20px;
            text-align: center;
            background: none;
            border: none;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #495057;
        }

        .nav-tab:hover {
            background: #e9ecef;
        }

        .nav-tab.active {
            background: white;
            color: #667eea;
            border-bottom: 3px solid #667eea;
            margin-bottom: -2px;
        }

        .tab-content {
            padding: 40px;
        }

        .hidden {
            display: none !important;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 1em;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        #previewSection {
            margin-top: 40px;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 10px;
            text-align: center;
        }

        #previewSection h3 {
            margin-bottom: 20px;
            color: #333;
        }

        #certificateCanvas {
            max-width: 100%;
            height: auto;
            border: 3px solid #dee2e6;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            margin: 20px 0;
            background: white;
        }

        .file-upload {
            border: 3px dashed #667eea;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .file-upload:hover {
            background: #e9ecef;
            border-color: #764ba2;
        }

        .file-upload input[type="file"] {
            display: none;
        }

        .file-upload-label {
            cursor: pointer;
            font-size: 1.1em;
            color: #667eea;
            font-weight: 600;
        }

        .csv-preview {
            margin-top: 30px;
            overflow-x: auto;
        }

        .csv-preview table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }

        .csv-preview th {
            background: #667eea;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        .csv-preview td {
            padding: 12px 15px;
            border-bottom: 1px solid #dee2e6;
        }

        .csv-preview tr:hover {
            background: #f8f9fa;
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            animation: slideIn 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .toast.success {
            background: #28a745;
        }

        .toast.error {
            background: #dc3545;
        }

        .toast.info {
            background: #17a2b8;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .progress-container {
            margin-top: 20px;
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e9ecef;
            border-radius: 15px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .info-box {
            background: #e7f3ff;
            border-left: 4px solid #667eea;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            color: #333;
        }

        #toastContainer {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }

            .tab-content {
                padding: 20px;
            }

            .button-group {
                flex-direction: column;
            }

            .btn {
                width: 100%;
                margin-right: 0;
                margin-bottom: 10px;
            }

            .nav-tabs {
                flex-direction: column;
            }

            .csv-preview table {
                font-size: 0.9em;
            }

            .csv-preview th,
            .csv-preview td {
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <div id="toastContainer"></div>

    <div class="container">
        <div class="header">
            <h1>üéì Certificate Generator</h1>
            <p>Professional Certificate Generation - Single or Bulk Mode</p>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" data-tab="single">Single Certificate</button>
            <button class="nav-tab" data-tab="bulk">Bulk Certificates</button>
        </div>

        <!-- Single Certificate Tab -->
        <div id="singleTab" class="tab-content">
            <h2 style="margin-bottom: 20px; color: #333;">Generate Single Certificate</h2>

            <div class="info-box">
                ‚ÑπÔ∏è Fill in the details below and preview your certificate before generating the PDF.
            </div>

            <form id="singleForm">
                <div class="form-group">
                    <label for="studentName">Student Name *</label>
                    <input type="text" id="studentName" placeholder="Enter student name" required>
                </div>

                <div class="form-group">
                    <label for="courseName">Course Name *</label>
                    <input type="text" id="courseName" placeholder="Enter course name" required>
                </div>

                <div class="form-group">
                    <label for="lecturerName">Lecturer Name *</label>
                    <input type="text" id="lecturerName" placeholder="Enter lecturer name" required>
                </div>

                <div class="form-group">
                    <label for="issueDate">Issue Date *</label>
                    <input type="date" id="issueDate" required>
                </div>

                <div class="form-group">
                    <label for="certificateType">Certificate Type *</label>
                    <select id="certificateType" required>
                        <option value="Completion">Certificate of Completion</option>
                        <option value="Achievement">Certificate of Achievement</option>
                        <option value="Excellence">Certificate of Excellence</option>
                    </select>
                </div>

                <div class="button-group">
                    <button type="submit" class="btn btn-primary">Preview Certificate</button>
                    <button type="button" id="clearFormBtn" class="btn btn-secondary">Clear</button>
                </div>
            </form>

            <div id="previewSection" class="hidden">
                <h3>Certificate Preview</h3>
                <canvas id="certificateCanvas"></canvas>
                <div class="button-group">
                    <button id="generatePdfBtn" class="btn btn-success">Generate PDF</button>
                    <button type="button" id="closePreviewBtn" class="btn btn-secondary">Close Preview</button>
                </div>
            </div>
        </div>

        <!-- Bulk Certificate Tab -->
        <div id="bulkTab" class="tab-content hidden">
            <h2 style="margin-bottom: 20px; color: #333;">Generate Bulk Certificates</h2>

            <div class="info-box">
                ‚ÑπÔ∏è Upload a CSV file with multiple students to generate certificates in bulk. Download the sample template to get started.
            </div>

            <div style="margin-bottom: 30px;">
                <button id="downloadCsvBtn" class="btn btn-secondary">üì• Download Sample CSV Template</button>
            </div>

            <div class="file-upload" onclick="document.getElementById('csvFileInput').click()">
                <input type="file" id="csvFileInput" accept=".csv">
                <div class="file-upload-label">
                    <p style="font-size: 3em; margin-bottom: 10px;">üìÅ</p>
                    <p>Click to upload CSV file or drag and drop</p>
                    <p style="margin-top: 10px; font-size: 0.9em; color: #6c757d;">CSV must contain: Student Name, Course Name, Lecturer Name, Issue Date, Certificate Type</p>
                </div>
            </div>

            <div id="csvPreviewContainer" class="csv-preview hidden">
                <h3 style="margin-bottom: 20px; color: #333;">Preview - <span id="csvCount">0</span> certificates</h3>
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Student Name</th>
                            <th>Course Name</th>
                            <th>Lecturer Name</th>
                            <th>Issue Date</th>
                            <th>Type</th>
                        </tr>
                    </thead>
                    <tbody id="csvPreviewBody"></tbody>
                </table>
                <div class="button-group">
                    <button id="generateBulkBtn" class="btn btn-success">üéØ Generate All Certificates (ZIP)</button>
                    <button type="button" id="clearCsvBtn" class="btn btn-secondary">Clear</button>
                </div>
            </div>

            <div class="progress-container" id="progressContainer">
                <p id="progressText" style="margin-bottom: 10px; font-weight: 600;">Generating certificates...</p>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill">0%</div>
                </div>
            </div>
        </div>
    </div>

    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/papaparse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <!-- Application JavaScript -->
    <script>
// ================================================================
// CERTIFICATE GENERATOR - FIXED LOGO & BULK ISSUES
// ================================================================

// Global variables
let logoImage = null;
const LOGO_PATH = 'logo-1.png';
let isGeneratingBulk = false;

// State management
const state = {
  currentTab: 'single',
  currentCertificateData: null,
  csvData: [],
  previewShown: false
};

// Initialize the application
function init() {
  setupEventListeners();
  setDefaultDate();
  initializeLogo();
}

// Initialize and load logo with proper aspect ratio handling
function initializeLogo() {
  logoImage = new Image();
  logoImage.src = LOGO_PATH;
  logoImage.crossOrigin = "Anonymous";
  logoImage.onerror = function() {
    console.warn('Logo not found at:', LOGO_PATH);
  };
  logoImage.onload = function() {
    console.log('Logo loaded successfully');
  };
}

// Setup all event listeners
function setupEventListeners() {
  document.querySelectorAll('.nav-tab').forEach(tab => {
    tab.addEventListener('click', (e) => switchTab(e.target.dataset.tab));
  });

  document.getElementById('singleForm').addEventListener('submit', handlePreview);
  document.getElementById('generatePdfBtn').addEventListener('click', handleGeneratePdf);
  document.getElementById('closePreviewBtn').addEventListener('click', () => {
    document.getElementById('previewSection').classList.add('hidden');
  });
  document.getElementById('clearFormBtn').addEventListener('click', () => {
    document.getElementById('singleForm').reset();
    setDefaultDate();
    document.getElementById('previewSection').classList.add('hidden');
  });

  document.getElementById('downloadCsvBtn').addEventListener('click', downloadSampleCsv);
  document.getElementById('csvFileInput').addEventListener('change', handleCsvUpload);
  document.getElementById('generateBulkBtn').addEventListener('click', handleGenerateBulk);
  document.getElementById('clearCsvBtn').addEventListener('click', () => {
    document.getElementById('csvFileInput').value = '';
    document.getElementById('csvPreviewContainer').classList.add('hidden');
    state.csvData = [];
  });

  setupDragAndDrop();
}

// Setup drag and drop for CSV
function setupDragAndDrop() {
  const fileUpload = document.querySelector('.file-upload');

  fileUpload.addEventListener('dragover', (e) => {
    e.preventDefault();
    fileUpload.style.background = '#e9ecef';
    fileUpload.style.borderColor = '#764ba2';
  });

  fileUpload.addEventListener('dragleave', () => {
    fileUpload.style.background = '#f8f9fa';
    fileUpload.style.borderColor = '#667eea';
  });

  fileUpload.addEventListener('drop', (e) => {
    e.preventDefault();
    fileUpload.style.background = '#f8f9fa';
    fileUpload.style.borderColor = '#667eea';

    const files = e.dataTransfer.files;
    if (files.length > 0) {
      document.getElementById('csvFileInput').files = files;
      handleCsvUpload({ target: { files: files } });
    }
  });
}

function setDefaultDate() {
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('issueDate').value = today;
}

function switchTab(tabName) {
  state.currentTab = tabName;

  document.querySelectorAll('.nav-tab').forEach(tab => {
    tab.classList.toggle('active', tab.dataset.tab === tabName);
  });

  document.getElementById('singleTab').classList.toggle('hidden', tabName !== 'single');
  document.getElementById('bulkTab').classList.toggle('hidden', tabName !== 'bulk');
}

function handlePreview(e) {
  e.preventDefault();

  const formData = {
    studentName: document.getElementById('studentName').value.trim(),
    courseName: document.getElementById('courseName').value.trim(),
    lecturerName: document.getElementById('lecturerName').value.trim(),
    issueDate: document.getElementById('issueDate').value,
    certificateType: document.getElementById('certificateType').value
  };

  if (!validateFormData(formData)) {
    showToast('Please fill in all required fields', 'error');
    return;
  }

  state.currentCertificateData = formData;
  drawCertificate(formData);

  document.getElementById('previewSection').classList.remove('hidden');
  document.getElementById('generatePdfBtn').disabled = false;
  state.previewShown = true;

  setTimeout(() => {
    document.getElementById('previewSection').scrollIntoView({ behavior: 'smooth', block: 'start' });
  }, 100);
}

function validateFormData(data) {
  return Object.values(data).every(value => value && value.toString().trim() !== '');
}

// FIXED: Logo drawing with proper aspect ratio
function drawCertificate(data) {
  const canvas = document.getElementById('certificateCanvas');
  const ctx = canvas.getContext('2d');

  const scale = 3;
  canvas.width = 1122 * scale;
  canvas.height = 794 * scale;

  ctx.scale(scale, scale);

  // Background
  ctx.fillStyle = '#ffffff';
  ctx.fillRect(0, 0, 1122, 794);

  // Outer border
  ctx.strokeStyle = '#d4af37';
  ctx.lineWidth = 12;
  ctx.strokeRect(30, 30, 1062, 734);

  // Inner border
  ctx.strokeStyle = '#b8860b';
  ctx.lineWidth = 2;
  ctx.strokeRect(45, 45, 1032, 704);

  // Decorative corners
  drawDecorativeCorners(ctx);

  // FIXED LOGO: Maintain aspect ratio, prevent distortion
  if (logoImage && logoImage.complete && logoImage.width > 0) {
    try {
      const logoMaxWidth = 100;
      const logoMaxHeight = 100;

      // Calculate aspect ratio to prevent distortion
      const aspectRatio = logoImage.width / logoImage.height;
      let logoWidth = logoMaxWidth;
      let logoHeight = logoMaxHeight;

      if (aspectRatio > 1) {
        logoHeight = logoMaxWidth / aspectRatio;
      } else {
        logoWidth = logoMaxHeight * aspectRatio;
      }

      const logoX = 561 - (logoWidth / 2);
      const logoY = 60;

      ctx.drawImage(logoImage, logoX, logoY, logoWidth, logoHeight);
    } catch(e) {
      console.warn('Error drawing logo:', e);
    }
  }

  // Certificate title
  ctx.fillStyle = '#1a1a2e';
  ctx.font = 'bold 48px Georgia, serif';
  ctx.textAlign = 'center';
  ctx.fillText('Certificate of ' + data.certificateType, 561, 220);

  // Decorative line
  ctx.strokeStyle = '#d4af37';
  ctx.lineWidth = 3;
  ctx.beginPath();
  ctx.moveTo(361, 240);
  ctx.lineTo(761, 240);
  ctx.stroke();

  // "This certifies that" text
  ctx.fillStyle = '#1a1a2e';
  ctx.font = 'italic 22px Georgia, serif';
  ctx.fillText('This certifies that', 561, 300);

  // Student name
  ctx.font = 'bold 44px Georgia, serif';
  ctx.fillStyle = '#1a1a2e';
  ctx.fillText(data.studentName, 561, 360);

  // Underline for name
  const nameWidth = ctx.measureText(data.studentName).width;
  ctx.strokeStyle = '#d4af37';
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(561 - nameWidth/2 - 15, 370);
  ctx.lineTo(561 + nameWidth/2 + 15, 370);
  ctx.stroke();

  // "has successfully completed" text
  ctx.font = 'italic 20px Georgia, serif';
  ctx.fillStyle = '#1a1a2e';
  ctx.fillText('has successfully completed the course', 561, 410);

  // Course name
  ctx.font = 'bold 32px Georgia, serif';
  ctx.fillStyle = '#1a1a2e';
  ctx.fillText(data.courseName, 561, 460);

  // Underline for course
  const courseWidth = ctx.measureText(data.courseName).width;
  ctx.strokeStyle = '#d4af37';
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(561 - courseWidth/2 - 15, 470);
  ctx.lineTo(561 + courseWidth/2 + 15, 470);
  ctx.stroke();

  // "under the instruction of" text
  ctx.font = 'italic 18px Georgia, serif';
  ctx.fillStyle = '#1a1a2e';
  ctx.fillText('under the instruction of', 561, 520);

  // Lecturer name
  ctx.font = 'bold 26px Georgia, serif';
  ctx.fillStyle = '#1a1a2e';
  ctx.fillText(data.lecturerName, 561, 560);

  // Issue date
  ctx.font = 'italic 18px Georgia, serif';
  ctx.fillStyle = '#1a1a2e';
  const formattedDate = formatDate(data.issueDate);
  ctx.fillText('Issued on: ' + formattedDate, 561, 670);

  // Signature line
  ctx.strokeStyle = '#1a1a2e';
  ctx.lineWidth = 1;
  ctx.beginPath();
  ctx.moveTo(411, 710);
  ctx.lineTo(711, 710);
  ctx.stroke();

  ctx.font = '14px Georgia, serif';
  ctx.fillStyle = '#1a1a2e';
  ctx.fillText('Authorized Signature', 561, 730);
}

function drawDecorativeCorners(ctx) {
  const cornerSize = 40;
  const offset = 45;
  ctx.strokeStyle = '#d4af37';
  ctx.lineWidth = 3;

  ctx.beginPath();
  ctx.moveTo(offset + cornerSize, offset);
  ctx.lineTo(offset, offset);
  ctx.lineTo(offset, offset + cornerSize);
  ctx.stroke();

  ctx.beginPath();
  ctx.moveTo(1122 - offset - cornerSize, offset);
  ctx.lineTo(1122 - offset, offset);
  ctx.lineTo(1122 - offset, offset + cornerSize);
  ctx.stroke();

  ctx.beginPath();
  ctx.moveTo(offset, 794 - offset - cornerSize);
  ctx.lineTo(offset, 794 - offset);
  ctx.lineTo(offset + cornerSize, 794 - offset);
  ctx.stroke();

  ctx.beginPath();
  ctx.moveTo(1122 - offset, 794 - offset - cornerSize);
  ctx.lineTo(1122 - offset, 794 - offset);
  ctx.lineTo(1122 - offset - cornerSize, 794 - offset);
  ctx.stroke();
}

function formatDate(dateString) {
  const date = new Date(dateString + 'T00:00:00');
  const options = { year: 'numeric', month: 'long', day: 'numeric' };
  return date.toLocaleDateString('en-US', options);
}

function handleGeneratePdf() {
  if (!state.currentCertificateData) {
    showToast('Please preview the certificate first', 'error');
    return;
  }

  generatePdfFromData(state.currentCertificateData);
  showToast('Certificate generated successfully!', 'success');
}

function generatePdfFromData(data) {
  const canvas = document.getElementById('certificateCanvas');
  const imgData = canvas.toDataURL('image/png', 1.0);

  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({
    orientation: 'landscape',
    unit: 'mm',
    format: 'a4'
  });

  pdf.addImage(imgData, 'PNG', 0, 0, 297, 210);

  const filename = sanitizeFilename(data.courseName + '_' + data.studentName + '.pdf');
  pdf.save(filename);
}

function sanitizeFilename(filename) {
  return filename
    .replace(/[^a-z0-9_-]/gi, '_')
    .replace(/_+/g, '_')
    .replace(/^_|_$/g, '')
    .toLowerCase();
}

function downloadSampleCsv() {
  const csvContent = [
    ['Student Name', 'Course Name', 'Lecturer Name', 'Issue Date', 'Certificate Type'],
    ['John Smith', 'Advanced JavaScript', 'Dr. Jane Doe', '2025-11-16', 'Achievement'],
    ['Emily Johnson', 'Web Development Fundamentals', 'Prof. Robert Brown', '2025-11-16', 'Completion'],
    ['Michael Chen', 'React Masterclass', 'Dr. Sarah Williams', '2025-11-16', 'Excellence']
  ];

  const csv = csvContent.map(row => 
    row.map(cell => '"' + cell + '"').join(',')
  ).join('\n');

  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = 'certificate_template.csv';
  link.click();

  showToast('Sample CSV downloaded', 'success');
}

function handleCsvUpload(e) {
  const file = e.target.files[0];
  if (!file) return;

  Papa.parse(file, {
    header: true,
    skipEmptyLines: true,
    complete: function(results) {
      if (results.errors.length > 0) {
        showToast('Error parsing CSV file', 'error');
        return;
      }

      if (!results.data || results.data.length === 0) {
        showToast('CSV file is empty', 'error');
        return;
      }

      const requiredColumns = ['Student Name', 'Course Name', 'Lecturer Name', 'Issue Date', 'Certificate Type'];
      const headers = Object.keys(results.data[0] || {});
      const missingColumns = requiredColumns.filter(col => !headers.includes(col));

      if (missingColumns.length > 0) {
        showToast('Missing columns: ' + missingColumns.join(', '), 'error');
        return;
      }

      const validData = results.data.filter(row => {
        return row['Student Name'] && row['Course Name'] && 
               row['Lecturer Name'] && row['Issue Date'] && 
               row['Certificate Type'];
      });

      if (validData.length === 0) {
        showToast('No valid data found in CSV', 'error');
        return;
      }

      state.csvData = validData;
      displayCsvPreview(validData);
      showToast(validData.length + ' certificates ready to generate', 'success');
    },
    error: function(error) {
      showToast('Error reading CSV file', 'error');
      console.error(error);
    }
  });
}

function displayCsvPreview(data) {
  const tbody = document.getElementById('csvPreviewBody');
  tbody.innerHTML = '';

  data.forEach((row, index) => {
    const tr = document.createElement('tr');
    tr.innerHTML = '<td>' + (index + 1) + '</td>' +
      '<td>' + escapeHtml(row['Student Name']) + '</td>' +
      '<td>' + escapeHtml(row['Course Name']) + '</td>' +
      '<td>' + escapeHtml(row['Lecturer Name']) + '</td>' +
      '<td>' + row['Issue Date'] + '</td>' +
      '<td>' + escapeHtml(row['Certificate Type']) + '</td>';
    tbody.appendChild(tr);
  });

  document.getElementById('csvCount').textContent = data.length;
  document.getElementById('csvPreviewContainer').classList.remove('hidden');
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// FIXED: Bulk certificate generation with proper error handling
async function handleGenerateBulk() {
  if (state.csvData.length === 0) {
    showToast('Please upload a CSV file first', 'error');
    return;
  }

  if (isGeneratingBulk) {
    showToast('Generation already in progress', 'info');
    return;
  }

  const btn = document.getElementById('generateBulkBtn');
  const originalText = btn.innerHTML;
  btn.innerHTML = 'Generating...';
  btn.disabled = true;
  isGeneratingBulk = true;

  document.getElementById('progressContainer').style.display = 'block';

  try {
    const zip = new JSZip();
    const { jsPDF } = window.jspdf;
    const totalCerts = state.csvData.length;
    let successCount = 0;

    for (let i = 0; i < totalCerts; i++) {
      try {
        const row = state.csvData[i];

        const certData = {
          studentName: String(row['Student Name']).trim(),
          courseName: String(row['Course Name']).trim(),
          lecturerName: String(row['Lecturer Name']).trim(),
          issueDate: String(row['Issue Date']).trim(),
          certificateType: String(row['Certificate Type']).trim()
        };

        // Validate each row
        if (!certData.studentName || !certData.courseName || !certData.lecturerName || !certData.issueDate || !certData.certificateType) {
          console.warn('Row ' + (i+1) + ' has missing data, skipping');
          continue;
        }

        // Create temporary canvas
        const tempCanvas = document.createElement('canvas');
        const scale = 3;
        tempCanvas.width = 1122 * scale;
        tempCanvas.height = 794 * scale;
        const ctx = tempCanvas.getContext('2d');
        ctx.scale(scale, scale);

        // Draw certificate on temporary canvas
        drawCertificateOnCanvas(ctx, certData);

        // Convert to PDF
        const imgData = tempCanvas.toDataURL('image/png', 1.0);
        const pdf = new jsPDF({
          orientation: 'landscape',
          unit: 'mm',
          format: 'a4'
        });
        pdf.addImage(imgData, 'PNG', 0, 0, 297, 210);

        // Add to ZIP
        const filename = sanitizeFilename(certData.courseName + '_' + certData.studentName + '.pdf');
        const pdfBlob = pdf.output('blob');
        zip.file(filename, pdfBlob);

        successCount++;

        // Update progress
        const progress = Math.round(((i + 1) / totalCerts) * 100);
        document.getElementById('progressFill').style.width = progress + '%';
        document.getElementById('progressFill').textContent = progress + '%';
        document.getElementById('progressText').textContent = 'Generated ' + successCount + ' of ' + totalCerts + ' certificates';

        // Small delay to prevent browser freezing
        if (i % 5 === 0) {
          await new Promise(resolve => setTimeout(resolve, 100));
        }

      } catch(certError) {
        console.error('Error generating certificate ' + (i+1) + ':', certError);
      }
    }

    if (successCount === 0) {
      showToast('No certificates were generated', 'error');
      return;
    }

    // Generate ZIP and download
    const zipBlob = await zip.generateAsync({ type: 'blob' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(zipBlob);
    link.download = 'certificates.zip';
    link.click();

    showToast('Successfully generated ' + successCount + ' of ' + totalCerts + ' certificates!', 'success');
  } catch (error) {
    showToast('Error generating certificates: ' + error.message, 'error');
    console.error('Bulk generation error:', error);
  } finally {
    btn.innerHTML = originalText;
    btn.disabled = false;
    isGeneratingBulk = false;
    document.getElementById('progressContainer').style.display = 'none';
  }
}

// Draw certificate on canvas (for bulk generation)
function drawCertificateOnCanvas(ctx, data) {
  // Background
  ctx.fillStyle = '#ffffff';
  ctx.fillRect(0, 0, 1122, 794);

  // Outer border
  ctx.strokeStyle = '#d4af37';
  ctx.lineWidth = 12;
  ctx.strokeRect(30, 30, 1062, 734);

  // Inner border
  ctx.strokeStyle = '#b8860b';
  ctx.lineWidth = 2;
  ctx.strokeRect(45, 45, 1032, 704);

  // Decorative corners
  drawDecorativeCorners(ctx);

  // FIXED LOGO: Same aspect ratio handling as preview
  if (logoImage && logoImage.complete && logoImage.width > 0) {
    try {
      const logoMaxWidth = 100;
      const logoMaxHeight = 100;

      const aspectRatio = logoImage.width / logoImage.height;
      let logoWidth = logoMaxWidth;
      let logoHeight = logoMaxHeight;

      if (aspectRatio > 1) {
        logoHeight = logoMaxWidth / aspectRatio;
      } else {
        logoWidth = logoMaxHeight * aspectRatio;
      }

      const logoX = 561 - (logoWidth / 2);
      const logoY = 60;

      ctx.drawImage(logoImage, logoX, logoY, logoWidth, logoHeight);
    } catch(e) {
      console.warn('Error drawing logo:', e);
    }
  }

  // Certificate title
  ctx.fillStyle = '#1a1a2e';
  ctx.font = 'bold 48px Georgia, serif';
  ctx.textAlign = 'center';
  ctx.fillText('Certificate of ' + data.certificateType, 561, 220);

  // Decorative line
  ctx.strokeStyle = '#d4af37';
  ctx.lineWidth = 3;
  ctx.beginPath();
  ctx.moveTo(361, 240);
  ctx.lineTo(761, 240);
  ctx.stroke();

  // Rest of certificate content
  ctx.fillStyle = '#1a1a2e';
  ctx.font = 'italic 22px Georgia, serif';
  ctx.fillText('This certifies that', 561, 300);

  ctx.font = 'bold 44px Georgia, serif';
  ctx.fillStyle = '#1a1a2e';
  ctx.fillText(data.studentName, 561, 360);

  const nameWidth = ctx.measureText(data.studentName).width;
  ctx.strokeStyle = '#d4af37';
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(561 - nameWidth/2 - 15, 370);
  ctx.lineTo(561 + nameWidth/2 + 15, 370);
  ctx.stroke();

  ctx.font = 'italic 20px Georgia, serif';
  ctx.fillStyle = '#1a1a2e';
  ctx.fillText('has successfully completed the course', 561, 410);

  ctx.font = 'bold 32px Georgia, serif';
  ctx.fillStyle = '#1a1a2e';
  ctx.fillText(data.courseName, 561, 460);

  const courseWidth = ctx.measureText(data.courseName).width;
  ctx.strokeStyle = '#d4af37';
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(561 - courseWidth/2 - 15, 470);
  ctx.lineTo(561 + courseWidth/2 + 15, 470);
  ctx.stroke();

  ctx.font = 'italic 18px Georgia, serif';
  ctx.fillStyle = '#1a1a2e';
  ctx.fillText('under the instruction of', 561, 520);

  ctx.font = 'bold 26px Georgia, serif';
  ctx.fillStyle = '#1a1a2e';
  ctx.fillText(data.lecturerName, 561, 560);

  ctx.font = 'italic 18px Georgia, serif';
  ctx.fillStyle = '#1a1a2e';
  const formattedDate = formatDate(data.issueDate);
  ctx.fillText('Issued on: ' + formattedDate, 561, 670);

  ctx.strokeStyle = '#1a1a2e';
  ctx.lineWidth = 1;
  ctx.beginPath();
  ctx.moveTo(411, 710);
  ctx.lineTo(711, 710);
  ctx.stroke();

  ctx.font = '14px Georgia, serif';
  ctx.fillStyle = '#1a1a2e';
  ctx.fillText('Authorized Signature', 561, 730);
}

function showToast(message, type) {
  if (!type) type = 'info';

  const container = document.getElementById('toastContainer');
  if (!container) return;

  const toast = document.createElement('div');
  toast.className = 'toast ' + type;
  toast.textContent = message;

  container.appendChild(toast);

  setTimeout(() => {
    toast.style.animation = 'slideIn 0.3s ease reverse';
    setTimeout(() => toast.remove(), 300);
  }, 3000);
}

if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', init);
} else {
  init();
}
    </script>
</body>
</html>
